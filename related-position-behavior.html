<script>
  if (Polymer.RelatedPositionBehavior) {
    console.warn('RelatedPositionBehavior is already implemented in Polymer!');
  }

  Polymer.RelatedPositionImpl = {
    hostAttributes: {
      'autoPos': ''
    },

    properties: {

      /**
       * Horizontal alignment of the subject relative to the target
       */
      halign: {
        type: String,
        value: 'left'
      },

      /**
       * Vertical alignment of the subject relative to the target
       */
      valign: {
        type: String,
        value: 'bottom'
      },

      /**
       * Additional spacing between the subject and the target
       */
      spacing: {
        type: Object,
        value: {
          top: 12,
          bottom: 12,
          left: 0,
          right: 0
        }
      }
    },

    updateRelatedPosition: function(target) {
      if (!target) {
        return;
      }

      var styles = window.getComputedStyle(this);
      if (styles.position !== 'relative' && styles.position !== 'absolute') {
        this.style.position = 'relative';
      }

      var padding = {
        left: parseInt(styles.paddingLeft),
        right: parseInt(styles.paddingRight),
        top: parseInt(styles.paddingTop),
        bottom: parseInt(styles.paddingBottom)
      };

      var top, left, bottom, right;
      var ref = this.getBoundingClientRect();
      var tarRec = target.getBoundingClientRect();

      if (this.halign === 'left') {
        left = (this.spacing.left || 0) + padding.left;

        if (ref.left + tarRec.width > window.innerWidth) {
          left = 0 - tarRec.width + ref.width - (this.spacing.right || 0) - padding.right;
        }
      } else if (this.halign === 'right') {
        left = 0 - tarRec.width + ref.width - (this.spacing.right || 0) - padding.right;

        if (ref.right - tarRec.width < 0) {
          left = (this.spacing.left || 0) + padding.left;
        }
      }

      if (this.valign === 'top') {
        top = 0 - tarRec.height - (this.spacing.top || 0) + padding.top;

        if (top + tarRec.top < 0) {
          top = ref.height + (this.spacing.bottom || 0) - padding.bottom;
        }
      } else if (this.valign === 'bottom') {
        top = ref.height + (this.spacing.bottom || 0) - padding.bottom;

        if (top + tarRec.height + ref.bottom > window.innerHeight) {
          top = 0 - tarRec.height - (this.spacing.top || 0) + padding.top;
        }
      }

      (top !== undefined) && (target.style.top = top + 'px');
      (left !== undefined) && (target.style.left = left + 'px');
      (bottom !== undefined) && (target.style.bottom = bottom + 'px');
      (right !== undefined) && (target.style.right = right + 'px');
    }
  };

  Polymer.RelatedPositionBehavior = [
    Polymer.RelatedPositionImpl
  ];
</script>
